# üîç Security Vulnerability Report

**Generated:** December 29, 2025  
**Project:** FMCG Distributor Control System  
**Version:** 4.0.0 (Fortress)

---

## üö® CRITICAL VULNERABILITIES

### 1. Vulnerable Dependency: `xlsx` (HIGH SEVERITY)

**Issue:** The `xlsx` package has known vulnerabilities:
- **Prototype Pollution** (GHSA-4r6h-8v6p-xvw6)
- **ReDoS (Regular Expression Denial of Service)** (GHSA-5pgg-2g8v-p4x9)

**Location:** `package.json` ‚Üí `xlsx: ^0.18.5`

**Risk:** Attackers can exploit these vulnerabilities through malicious Excel files uploaded via `/api/import/excel`

**Remediation Options:**
```bash
# Option 1: Replace xlsx with a safer alternative
npm uninstall xlsx
npm install exceljs

# Option 2: If xlsx is required, ensure files are validated before processing
# Add additional server-side validation
```

**Workaround:** The current implementation in `routes/import.js` should:
1. ‚úÖ Already limits file size to 10MB
2. ‚ö†Ô∏è Add timeout for parsing operations
3. ‚ö†Ô∏è Sandbox the parsing in a worker thread

---

## ‚ö†Ô∏è MEDIUM VULNERABILITIES

### 2. Weak Session Secret in `.env`

**Issue:** Default session secret is still placeholder
```
SESSION_SECRET=your-super-secret-key-change-in-production
```

**Risk:** Predictable session tokens if not changed in production

**Remediation:**
```bash
# Generate a strong secret
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

Then update `.env`:
```
SESSION_SECRET=<generated-64-byte-hex-string>
```

---

### 3. Frontend XSS via `innerHTML` (Multiple Files)

**Issue:** Direct use of `innerHTML` with data from API responses without escaping

**Affected Files:**
- `public/js/retailers.js` - Line 41, 60
- `public/js/weekly-review.js` - Lines 33, 37, 60, 64, 79, 83, 105
- `public/js/profit-analysis.js` - Lines 55, 59, 94, 98, 131, 135
- `public/js/product-test.js` - Lines 34, 38
- `public/js/excel-import.js` - Lines 82, 154, 159, 161

**Example Vulnerable Code:**
```javascript
// retailers.js line 60
tbody.innerHTML = retailers.map((retailer) => {
    return `<td><strong>${retailer.name}</strong></td>`;  // XSS if name contains HTML
}).join('');
```

**Risk:** If an attacker injects `<script>` tags or event handlers in retailer names, they execute when rendered

**Remediation:** Create and use an escape function:
```javascript
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Safe usage:
`<td><strong>${escapeHtml(retailer.name)}</strong></td>`
```

---

## üìã LOW SEVERITY ISSUES

### 4. Missing Content-Security-Policy `upgrade-insecure-requests`

**Current CSP in `middleware/security.js`:**
```javascript
"default-src 'self'; script-src 'self' 'unsafe-inline'"
```

**Recommendation:** Add `upgrade-insecure-requests` for production:
```javascript
"default-src 'self'; script-src 'self' 'unsafe-inline'; upgrade-insecure-requests"
```

---

### 5. `unsafe-inline` in CSP Script Source

**Issue:** `script-src 'unsafe-inline'` allows inline JavaScript, reducing XSS protection

**Recommendation:** Use nonces or hashes in production:
```javascript
"script-src 'self' 'nonce-${generateNonce()}'"
```

---

### 6. Database File Permission

**Issue:** `distributor.db` may have overly permissive access

**Recommendation:** Ensure file permissions are restricted:
```bash
# Linux/Mac
chmod 600 distributor.db
```

---

## ‚úÖ VERIFIED SECURE

The following security measures are properly implemented:

| Feature | Status | Notes |
|---------|--------|-------|
| Password Hashing | ‚úÖ SECURE | bcrypt with cost 12 |
| SQL Injection | ‚úÖ SECURE | Parameterized queries |
| CSRF Protection | ‚úÖ SECURE | Origin validation + SameSite |
| Rate Limiting | ‚úÖ SECURE | Auth + general limits |
| Account Lockout | ‚úÖ SECURE | Progressive lockout |
| Secure Cookies | ‚úÖ SECURE | HttpOnly, Secure, SameSite |
| HTTPS Headers | ‚úÖ SECURE | HSTS enabled |
| Clickjacking | ‚úÖ SECURE | X-Frame-Options: DENY |
| Path Traversal | ‚úÖ SECURE | Sanitization middleware |
| SSRF Protection | ‚úÖ SECURE | IP blocking |
| Mass Assignment | ‚úÖ SECURE | Field whitelisting |
| Error Handling | ‚úÖ SECURE | Generic messages |
| .env Security | ‚úÖ SECURE | In .gitignore |
| File Upload | ‚úÖ SECURE | Size + type limits |

---

## üîß RECOMMENDED ACTIONS

### Priority 1 (Do Immediately):
1. ‚¨ú Replace or sandbox `xlsx` package
2. ‚¨ú Change SESSION_SECRET to a secure random value
3. ‚¨ú Add HTML escaping to all frontend `innerHTML` usage

### Priority 2 (Before Production):
4. ‚¨ú Remove `'unsafe-inline'` from CSP
5. ‚¨ú Add `upgrade-insecure-requests` to CSP
6. ‚¨ú Set database file permissions

### Priority 3 (Ongoing):
7. ‚¨ú Run `npm audit` weekly
8. ‚¨ú Review security audit logs
9. ‚¨ú Update dependencies monthly

---

## üìä SUMMARY

| Severity | Count | Status |
|----------|-------|--------|
| üî¥ Critical | 1 | xlsx vulnerability |
| üü† Medium | 2 | Session secret, Frontend XSS |
| üü° Low | 3 | CSP improvements |
| üü¢ Secure | 14 | Properly implemented |

**Overall Security Score: 78/100**

The core backend security is solid. Focus on:
1. Replacing vulnerable xlsx package
2. Adding frontend XSS escaping
3. Updating session secret for production
